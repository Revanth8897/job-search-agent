<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Apply | Job Agent</title>
  <link rel="stylesheet" href="../../public/style.css?v=4" />

</head>
<body>
  <div id="app"></div>

  <script type="module">
    import { requireAuth } from "../utils/protect.js";
    import { renderDashboardLayout } from "../components/layout.js";

    requireAuth();

    const TRACKING_KEY = "tracking_jobs";
    const DRAFT_KEY = "apply_draft";

    // Same mock list as recommendations (IDs must match)
    const jobs = [
      {
        id: "rec1",
        title: "Frontend Developer (React)",
        company: "Google",
        location: "Remote",
        type: "Full-time",
        source: "Indeed",
        desc: "Work on high performance UI systems, build reusable components, and collaborate with product + design."
      },
      {
        id: "rec2",
        title: "Data Analyst Intern",
        company: "Microsoft",
        location: "Hyderabad",
        type: "Internship",
        source: "LinkedIn",
        desc: "Analyze business datasets, build dashboards, and support product decisions with insights."
      },
      {
        id: "rec3",
        title: "Junior Software Engineer",
        company: "Amazon",
        location: "Bangalore",
        type: "Full-time",
        source: "Naukri",
        desc: "Build scalable APIs, work with databases, and follow clean coding practices in production systems."
      }
    ];

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    function getTracking() {
      try {
        return JSON.parse(localStorage.getItem(TRACKING_KEY)) || [];
      } catch {
        return [];
      }
    }

    function setTracking(list) {
      localStorage.setItem(TRACKING_KEY, JSON.stringify(list));
    }

    function upsertTracking(job, data) {
      const list = getTracking();

      const existingIndex = list.findIndex((x) => x.id === job.id);

      const record = {
        id: job.id,
        title: job.title,
        company: job.company,
        location: job.location,
        type: job.type,
        source: job.source,

        status: "Applied",
        appliedAt: new Date().toISOString(),
        coverLetter: data.coverLetter || "",
        notes: data.notes || ""
      };

      if (existingIndex === -1) {
        list.unshift(record);
      } else {
        list[existingIndex] = { ...list[existingIndex], ...record };
      }

      setTracking(list);
    }

    // -----------------------------
    // Draft (Week 4 polish)
    // -----------------------------
    function getDraft() {
      try {
        return JSON.parse(localStorage.getItem(DRAFT_KEY)) || {};
      } catch {
        return {};
      }
    }

    function setDraft(draft) {
      localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
    }

    function clearDraft() {
      localStorage.removeItem(DRAFT_KEY);
    }

    // -----------------------------
    // Find job
    // -----------------------------
    const jobId = getQueryParam("id");
    const job = jobs.find((j) => j.id === jobId);

    // -----------------------------
    // Job not found
    // -----------------------------
    if (!job) {
      renderDashboardLayout({
        active: "reco",
        content: `
          <h1 class="section-title">Apply</h1>
          <p class="section-subtitle">Job not found.</p>

          <div class="card" style="margin-top:18px;">
            <h2 style="font-weight:1000;">Invalid job link</h2>
            <p class="muted" style="margin-top:6px;">
              Go back to Recommendations page and try again.
            </p>

            <div class="row">
              <a class="btn btn-primary" href="./recommendations.html" style="width:auto;">
                Back to Recommendations
              </a>
            </div>
          </div>
        `
      });
    } else {
      // -----------------------------
      // Apply UI
      // -----------------------------
      renderDashboardLayout({
        active: "reco",
        content: `
          <div class="apply-head">
            <div>
              <h1 class="section-title">Apply</h1>
              <p class="section-subtitle">
                Fill application details. This will be saved in Tracking.
              </p>
            </div>

            <div class="apply-badges">
              <span class="badge">Auto-save draft</span>
              <span class="badge">Tracking enabled</span>
            </div>
          </div>

          <div class="apply-grid" style="margin-top:18px;">
            <!-- Job Preview -->
            <div class="card apply-preview">
              <div class="apply-preview-top">
                <div>
                  <div style="font-weight:1000; font-size:18px;">${job.title}</div>
                  <div class="muted" style="margin-top:4px;">${job.company}</div>
                </div>

                <span class="badge">Job Preview</span>
              </div>

              <div class="job-meta" style="margin-top:14px;">
                <span class="badge">${job.location}</span>
                <span class="badge">${job.type}</span>
                <span class="badge">Source: ${job.source}</span>
              </div>

              <div style="margin-top:16px;">
                <h3 style="font-weight:1000;">Description</h3>
                <p class="muted" style="margin-top:8px; line-height:1.7;">
                  ${job.desc}
                </p>
              </div>

              <div class="hr"></div>

              <div class="apply-tip">
                <div class="apply-tip-icon">ðŸ’¡</div>
                <div>
                  <div style="font-weight:1000;">Pro tip</div>
                  <div class="muted" style="margin-top:4px;">
                    Add recruiter name + job URL in notes. Your guide will love this.
                  </div>
                </div>
              </div>
            </div>

            <!-- Form -->
            <div class="card apply-form-card">
              <div class="apply-form-head">
                <h2 style="font-weight:1000;">Application Form</h2>
                <div class="muted" id="draftStatus" style="font-weight:800;">
                  Draft not saved yet
                </div>
              </div>

              <form id="applyForm" style="margin-top:14px;">
                <label class="label">Cover Letter (optional)</label>
                <textarea
                  class="textarea"
                  id="coverLetter"
                  placeholder="Write a short cover letter..."
                ></textarea>

                <div style="margin-top:14px;">
                  <label class="label">Notes (optional)</label>
                  <textarea
                    class="textarea"
                    id="notes"
                    placeholder="Recruiter name, job URL, salary, follow-up date..."
                  ></textarea>
                </div>

                <div class="apply-actions">
                  <button class="btn btn-primary" id="submitBtn" type="submit" style="width:auto;">
                    Submit Application
                  </button>

                  <button class="btn btn-outline" id="clearDraftBtn" type="button" style="width:auto;">
                    Clear Draft
                  </button>

                  <a class="btn btn-outline" href="./recommendations.html" style="width:auto;">
                    Cancel
                  </a>
                </div>
              </form>
            </div>
          </div>
        `
      });

      const form = document.getElementById("applyForm");
      const submitBtn = document.getElementById("submitBtn");
      const coverLetter = document.getElementById("coverLetter");
      const notes = document.getElementById("notes");
      const draftStatus = document.getElementById("draftStatus");
      const clearDraftBtn = document.getElementById("clearDraftBtn");

      // -----------------------------
      // Load draft
      // -----------------------------
      const draft = getDraft();
      if (draft?.jobId === job.id) {
        coverLetter.value = draft.coverLetter || "";
        notes.value = draft.notes || "";
        draftStatus.textContent = "Draft loaded âœ“";
      }

      // -----------------------------
      // Auto-save draft (Week 4)
      // -----------------------------
      let draftTimer = null;

      function markSaved() {
        draftStatus.textContent = "Draft saved âœ“";
      }

      function markSaving() {
        draftStatus.textContent = "Saving draft...";
      }

      function saveDraftNow() {
        setDraft({
          jobId: job.id,
          coverLetter: coverLetter.value.trim(),
          notes: notes.value.trim(),
          updatedAt: new Date().toISOString()
        });
        markSaved();
      }

      function scheduleDraftSave() {
        markSaving();
        clearTimeout(draftTimer);
        draftTimer = setTimeout(saveDraftNow, 500);
      }

      coverLetter.addEventListener("input", scheduleDraftSave);
      notes.addEventListener("input", scheduleDraftSave);

      clearDraftBtn.addEventListener("click", () => {
        const ok = confirm("Clear saved draft?");
        if (!ok) return;

        coverLetter.value = "";
        notes.value = "";
        clearDraft();
        draftStatus.textContent = "Draft cleared";
      });

      // -----------------------------
      // Submit
      // -----------------------------
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        submitBtn.disabled = true;
        submitBtn.classList.add("btn-loading");
        submitBtn.innerHTML = `<span class="spinner"></span> Submitting...`;

        await new Promise((r) => setTimeout(r, 900));

        upsertTracking(job, {
          coverLetter: coverLetter.value.trim(),
          notes: notes.value.trim()
        });

        clearDraft();

        submitBtn.disabled = false;
        submitBtn.classList.remove("btn-loading");
        submitBtn.innerHTML = "Submit Application";

        alert("Application saved! Redirecting to Tracking page...");

        window.location.href = "./tracking.html";
      });
    }
  </script>
</body>
</html>
