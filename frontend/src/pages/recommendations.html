<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recommendations | Job Agent</title>
  <link rel="stylesheet" href="../../public/style.css?v=4" />
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import { requireAuth } from "../utils/protect.js";
    import { renderDashboardLayout } from "../components/layout.js";

    requireAuth();

    const STORAGE_KEY = "saved_jobs";

    const recommendations = [
      {
        id: "rec1",
        title: "Frontend Developer (React)",
        company: "Google",
        location: "Remote",
        type: "Full-time",
        source: "Indeed",
        score: 92,
        why: ["JavaScript", "HTML", "CSS", "React", "REST API"],
        desc: "Work on high performance UI systems, build reusable components, and collaborate with product + design."
      },
      {
        id: "rec2",
        title: "Data Analyst Intern",
        company: "Microsoft",
        location: "Hyderabad",
        type: "Internship",
        source: "LinkedIn",
        score: 84,
        why: ["SQL", "Excel", "Python", "Dashboards"],
        desc: "Analyze business datasets, build dashboards, and support product decisions with insights."
      },
      {
        id: "rec3",
        title: "Junior Software Engineer",
        company: "Amazon",
        location: "Bangalore",
        type: "Full-time",
        source: "Naukri",
        score: 79,
        why: ["DSA", "Node.js", "Git", "APIs"],
        desc: "Build scalable APIs, work with databases, and follow clean coding practices in production systems."
      }
    ];

    // -----------------------------
    // Saved Jobs
    // -----------------------------
    function getSavedJobs() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      } catch {
        return [];
      }
    }

    function setSavedJobs(ids) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(ids));
      window.dispatchEvent(new Event("savedJobsUpdated"));
    }

    function isSaved(jobId) {
      return getSavedJobs().includes(jobId);
    }

    function toggleSave(jobId) {
      const saved = getSavedJobs();

      if (saved.includes(jobId)) {
        setSavedJobs(saved.filter((x) => x !== jobId));
        return false;
      }

      saved.push(jobId);
      setSavedJobs(saved);
      return true;
    }

    // -----------------------------
    // Modal
    // -----------------------------
    function openModal(job) {
      const modal = document.createElement("div");
      modal.className = "modal-backdrop";

      modal.innerHTML = `
        <div class="modal">
          <div class="modal-head">
            <div>
              <div style="font-weight:1000; font-size:18px;">${job.title}</div>
              <div class="muted">${job.company}</div>
            </div>
            <button class="modal-close" id="closeModal">✕</button>
          </div>

          <div class="modal-body">
            <div class="job-meta">
              <span class="badge">${job.location}</span>
              <span class="badge">${job.type}</span>
              <span class="badge">Source: ${job.source}</span>
              <span class="match-score">${job.score}% Match</span>
            </div>

            <div style="margin-top:14px;">
              <h3 style="font-weight:1000;">Why recommended</h3>
              <div class="why-list">
                ${job.why.map((s) => `<span class="why-chip">${s}</span>`).join("")}
              </div>
            </div>

            <div style="margin-top:14px;">
              <h3 style="font-weight:1000;">Description</h3>
              <p class="muted" style="margin-top:6px; line-height:1.7;">
                ${job.desc}
              </p>
            </div>

            <div class="row" style="margin-top:18px;">
              <a class="btn btn-primary" href="./apply.html?id=${job.id}" style="width:auto;">
                Apply Now
              </a>

              <button class="btn btn-outline" id="saveJobBtn" style="width:auto;">
                ${isSaved(job.id) ? "Saved ✓" : "Save Job"}
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      function close() {
        modal.remove();
      }

      modal.addEventListener("click", (e) => {
        if (e.target === modal) close();
      });

      modal.querySelector("#closeModal").addEventListener("click", close);

      modal.querySelector("#saveJobBtn").addEventListener("click", () => {
        toggleSave(job.id);
        close();
        renderPage();
      });
    }

    // -----------------------------
    // Helpers
    // -----------------------------
    function sortList(list, sort) {
      const arr = [...list];

      if (sort === "best") return arr.sort((a, b) => b.score - a.score);
      if (sort === "company") return arr.sort((a, b) => a.company.localeCompare(b.company));
      if (sort === "title") return arr.sort((a, b) => a.title.localeCompare(b.title));
      return arr;
    }

    function getTop3(list) {
      return [...list].sort((a, b) => b.score - a.score).slice(0, 3);
    }

    // -----------------------------
    // Page Render
    // -----------------------------
    function renderPage() {
      renderDashboardLayout({
        active: "reco",
        content: `
          <div class="reco-hero">
            <div>
              <h1 class="section-title">AI Recommendations</h1>
              <p class="section-subtitle">
                Ranked jobs based on your resume skills + job platform signals (mock).
              </p>
            </div>

            <div class="reco-hero-right">
  <span class="badge">Resume skills</span>
  <span class="badge">Job APIs</span>
  <span class="badge">AI Match Score</span>
  <span class="badge">Auto ranked</span>
</div>

          </div>

          <!-- Summary -->
          <div class="reco-summary">
            <div class="reco-summary-card">
              <div class="muted">Total Recommendations</div>
              <div class="reco-num">${recommendations.length}</div>
            </div>

            <div class="reco-summary-card">
              <div class="muted">Best Match</div>
              <div class="reco-num">${Math.max(...recommendations.map(r => r.score))}%</div>
            </div>

            <div class="reco-summary-card">
              <div class="muted">Saved Jobs</div>
              <div class="reco-num">${getSavedJobs().length}</div>
            </div>
          </div>

          <!-- Top 3 -->
          <div class="card" style="margin-top:18px;">
            <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
              <div>
                <h2 style="font-weight:1000;">Top Picks</h2>
                <p class="muted" style="margin-top:6px;">
                  Highest confidence jobs for your profile.
                </p>
              </div>
              <span class="badge">Auto ranked</span>
            </div>

            <div class="reco-top-grid" id="topGrid"></div>
          </div>

          <!-- Filters -->
          <div class="filter-bar" style="margin-top:18px;">
            <input class="input" id="searchReco"
              placeholder="Search title / company..."
              style="flex:1; min-width:240px;" />

            <select class="select" id="minScore">
              <option value="0">All Matches</option>
              <option value="70">70%+</option>
              <option value="80">80%+</option>
              <option value="90">90%+</option>
            </select>

            <select class="select" id="sortReco">
              <option value="best">Sort: Best Match</option>
              <option value="company">Sort: Company A-Z</option>
              <option value="title">Sort: Title A-Z</option>
            </select>

            <div class="badge" id="recoCount">0 jobs</div>
          </div>

          <div class="jobs-grid" id="recoGrid"></div>

          <div id="emptyReco" style="display:none; margin-top:18px;">
            <div class="card">
              <h2 style="font-weight:1000;">No recommendations found</h2>
              <p class="muted" style="margin-top:6px;">
                Try lowering the match score filter or clearing the search.
              </p>
              <div class="row">
                <button class="btn btn-primary" id="resetRecoBtn" style="width:auto;">
                  Reset Filters
                </button>
              </div>
            </div>
          </div>
        `
      });

      const recoGrid = document.getElementById("recoGrid");
      const topGrid = document.getElementById("topGrid");

      const searchReco = document.getElementById("searchReco");
      const minScore = document.getElementById("minScore");
      const sortReco = document.getElementById("sortReco");

      const recoCount = document.getElementById("recoCount");
      const emptyReco = document.getElementById("emptyReco");
      const resetRecoBtn = document.getElementById("resetRecoBtn");

      // Render top 3
      const top3 = getTop3(recommendations);

      topGrid.innerHTML = top3.map((job, idx) => `
        <div class="reco-top-card" data-open="${job.id}">
          <div class="reco-rank">#${idx + 1}</div>

          <div class="reco-top-title">${job.title}</div>
          <div class="muted" style="margin-top:4px; font-weight:800;">
            ${job.company}
          </div>

          <div class="job-meta" style="margin-top:12px;">
            <span class="badge">${job.location}</span>
            <span class="badge">${job.type}</span>
            <span class="match-score">${job.score}%</span>
          </div>

          <div class="why-list" style="margin-top:12px;">
            ${job.why.slice(0, 3).map((s) => `<span class="why-chip">${s}</span>`).join("")}
          </div>
        </div>
      `).join("");

      topGrid.querySelectorAll("[data-open]").forEach((el) => {
        el.addEventListener("click", () => {
          const id = el.getAttribute("data-open");
          const job = recommendations.find((j) => j.id === id);
          if (job) openModal(job);
        });
      });

      // Render list
      function renderList(list) {
        recoCount.textContent = `${list.length} jobs`;

        if (list.length === 0) {
          recoGrid.innerHTML = "";
          emptyReco.style.display = "block";
          return;
        }

        emptyReco.style.display = "none";

        recoGrid.innerHTML = list.map((job) => {
          const saved = isSaved(job.id);

          return `
            <div class="job-card">
              <div class="job-left" style="cursor:pointer;" data-open="${job.id}">
                <div class="reco-title-row">
                  <div class="job-title">${job.title}</div>
                  <span class="match-score">${job.score}% Match</span>
                </div>

                <div class="job-company">${job.company}</div>

                <div class="job-meta">
                  <span class="badge">${job.location}</span>
                  <span class="badge">${job.type}</span>
                  <span class="badge">Source: ${job.source}</span>
                </div>

                <div class="why-list">
                  ${job.why.slice(0, 4).map((s) => `<span class="why-chip">${s}</span>`).join("")}
                  ${job.why.length > 4 ? `<span class="why-chip">+${job.why.length - 4} more</span>` : ""}
                </div>

                <div class="job-desc">${job.desc}</div>
              </div>

              <div class="job-actions">
                <a class="btn btn-primary" href="./apply.html?id=${job.id}" style="width:auto;">
                  Apply
                </a>

                <button class="btn btn-outline" data-save="${job.id}" style="width:auto;">
                  ${saved ? "Saved ✓" : "Save"}
                </button>
              </div>
            </div>
          `;
        }).join("");

        // Save toggle
        recoGrid.querySelectorAll("[data-save]").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            const id = btn.getAttribute("data-save");
            const nowSaved = toggleSave(id);
            btn.textContent = nowSaved ? "Saved ✓" : "Save";
          });
        });

        // Open modal
        recoGrid.querySelectorAll("[data-open]").forEach((el) => {
          el.addEventListener("click", () => {
            const id = el.getAttribute("data-open");
            const job = recommendations.find((j) => j.id === id);
            if (job) openModal(job);
          });
        });
      }

      function applyFilters() {
        const q = searchReco.value.trim().toLowerCase();
        const scoreMin = parseInt(minScore.value, 10);
        const sort = sortReco.value;

        const filtered = recommendations.filter((j) => {
          const matchText =
            j.title.toLowerCase().includes(q) ||
            j.company.toLowerCase().includes(q);

          const matchScore = j.score >= scoreMin;

          return matchText && matchScore;
        });

        renderList(sortList(filtered, sort));
      }

      searchReco.addEventListener("input", applyFilters);
      minScore.addEventListener("change", applyFilters);
      sortReco.addEventListener("change", applyFilters);

      if (resetRecoBtn) {
        resetRecoBtn.addEventListener("click", () => {
          searchReco.value = "";
          minScore.value = "0";
          sortReco.value = "best";
          applyFilters();
        });
      }

      applyFilters();
    }

    renderPage();
  </script>
</body>
</html>
